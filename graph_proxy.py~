import networkx as nx

class GraphProxy:

    def __init__(self, component_list):

        self._graph = nx.DiGraph()
        self._graph.add_nodes_from(component_list)

    def is_contiguous(self):
        undir = nx.Graph()
        undir.add_nodes_from(self._graph.nodes())
        undir.add_edges_from(self._graph.edges())
        return nx.is_connected(undir)

    def add_node(self, thing):
        # Add thing to graph and set its graph proxy to us
        nodes_to_add = thing.graph_proxy.get_nodes()
        edges_to_add = thing.graph_proxy.get_edges()
        self._graph.add_nodes_from(nodes_to_add)
        for node in nodes_to_add:
            node.graph_proxy = self

    def add_link(self, source, target):
        # unless target is in graph already, add it
        if not target in self._graph.nodes():
            self.add_node(target)
            # Now add the edge
        self._graph.add_edge(source, target)

    def split_graphs(self):
        components = nx.weakly_connected_component_subgraphs(self._graph) + \
            nx.strongly_connected_component_subgraphs(self._graph)

        for component in components:
            new_proxy = GraphProxy(component.nodes())
            for node in component.nodes():
                node.graph_proxy = new_proxy

    def remove_link(self, source, target):
        self._graph.remove_edge(source, target)
        print(str(self._graph.nodes()))
        if not self.is_contiguous():
            print "splitting!"
            self.split_graphs()

    def get_nodes(self):
        return self._graph.nodes()

    def get_edges(self):
        return self._graph.edges()

if __name__ == "__main__":

    from component import Component

    a = Component(name="a")
    b = Component(name="b")
    c = Component(name="c")
    d = Component(name="d")
    e = Component(name="e")
    f = Component(name="f")
    g = Component(name="g")

    b.plug_into(a)
    d.plug_into(b)
    d.plug_into(c)
    e.plug_into(f)
    e.plug_into(d)
    e.plug_into(g)

    d.unplug_from(e)
